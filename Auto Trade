task.wait(5)
-- --- KONFIGURASI GLOBAL ---
getgenv().AutoTradeGalactio = false  
_G.AutoTradeEnabled = false 
getgenv().nickname = "AkbarSiRaja_283"

local player = game.Players.LocalPlayer
local coreGui = game:GetService("CoreGui")
local VIM = game:GetService("VirtualInputManager")
local UIS = game:GetService("UserInputService")
local lp = player

-- --- 1. FUNCTION: UNEQUIP ---
local function unequipAll()
    if lp.Character then
        local humanoid = lp.Character:FindFirstChildOfClass("Humanoid")
        if humanoid then humanoid:UnequipTools() end
    end
end

-- --- 2. FUNCTION: HITUNG ITEM (DIJAMIN AKURAT) ---
local function getInventoryData()
    local adminItems = {}
    local backpack = player.Backpack:GetChildren()
    local character = player.Character and player.Character:GetChildren() or {}
    
    for _, item in pairs(backpack) do
        if item:IsA("Tool") and item:GetAttribute("BrainrotName") == "Galactio Fantasma" and item:GetAttribute("Mutation") == "Admin" then
            table.insert(adminItems, item)
        end
    end
    
    for _, item in pairs(character) do
        if item:IsA("Tool") and item:GetAttribute("BrainrotName") == "Galactio Fantasma" and item:GetAttribute("Mutation") == "Admin" then
            table.insert(adminItems, item)
        end
    end
    
    return adminItems
end

-- --- 3. MAIN TRADE LOGIC (ULTRA SAFETY) ---
task.spawn(function()
    while task.wait(0.8) do -- Jeda sedikit lebih lama agar server tidak rate-limit
        if getgenv().AutoTradeGalactio then
            local currentItems = getInventoryData()
            
            -- PROTEKSI TOTAL: Jika sisa 1 atau kurang, langsung MATIKAN fungsi.
            if #currentItems <= 1 then
                getgenv().AutoTradeGalactio = false
                unequipAll()
                warn("SAFETY TRIGGERED: Hanya tersisa 1 item. Sistem dimatikan.")
                continue
            end

            -- CEK TARGET
            local targetPlr = game.Players:FindFirstChild(getgenv().nickname)
            if not targetPlr or not targetPlr.Character or not targetPlr.Character:FindFirstChild("HumanoidRootPart") then
                continue 
            end

            -- AMBIL ITEM (Selalu sisakan satu, ambil yang index terakhir)
            local itemToSend = currentItems[#currentItems] 
            
            if itemToSend and itemToSend.Parent then
                local hum = player.Character:FindFirstChildOfClass("Humanoid")
                if hum then
                    -- Equip dan tunggu sebentar
                    hum:EquipTool(itemToSend)
                    task.wait(0.4) 
                    
                    -- VERIFIKASI ULANG SETELAH EQUIP
                    local finalCheck = getInventoryData()
                    if #finalCheck > 1 then
                        local prompt = targetPlr.Character.HumanoidRootPart:FindFirstChild("TradePrompt")
                        if prompt then 
                            fireproximityprompt(prompt) 
                        end
                    else
                        -- Jika tiba-tiba sisa 1 saat mau kirim, batalkan!
                        unequipAll()
                        getgenv().AutoTradeGalactio = false
                    end
                end
            end
        end
    end
end)

-- --- 4. AUTO ACCEPT LOOP ---
task.spawn(function()
    while task.wait(0.5) do
        if _G.AutoTradeEnabled then
            local requestUI = lp.PlayerGui:FindFirstChild("TradeRequest")
            if requestUI then
                local viewport = workspace.CurrentCamera.ViewportSize
                VIM:SendMouseButtonEvent(viewport.X * 0.43, viewport.Y * 0.62, 0, true, game, 0)
                task.wait(0.05)
                VIM:SendMouseButtonEvent(viewport.X * 0.43, viewport.Y * 0.62, 0, false, game, 0)
                task.wait(0.2)
                unequipAll()
            end
        end
    end
end)

-- --- UI SETUP ---
if coreGui:FindFirstChild("GalactioFinalV4") then coreGui.GalactioFinalV4:Destroy() end
local screenGui = Instance.new("ScreenGui", coreGui)
screenGui.Name = "GalactioFinalV4"

local mainFrame = Instance.new("Frame", screenGui)
mainFrame.Size = UDim2.new(0, 240, 0, 300)
mainFrame.Position = UDim2.new(0.5, -120, 0.3, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
mainFrame.Active, mainFrame.Draggable = true, true
Instance.new("UICorner", mainFrame)

local layout = Instance.new("UIListLayout", mainFrame)
layout.Padding = UDim.new(0, 6)
layout.HorizontalAlignment = Enum.HorizontalAlignment.Center

local title = Instance.new("TextLabel", mainFrame)
title.Size = UDim2.new(1, 0, 0, 40)
title.Text = "PHONK ONTOP"
title.TextColor3 = Color3.new(1, 1, 1)
title.Font = Enum.Font.GothamBold
title.BackgroundTransparency = 1

local function createBtn(txt, varName, isGlobal, customColor)
    local btn = Instance.new("TextButton", mainFrame)
    btn.Size = UDim2.new(0.9, 0, 0, 35)
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 10
    Instance.new("UICorner", btn)

    task.spawn(function()
        while task.wait(0.2) do
            local val = isGlobal and _G[varName] or getgenv()[varName]
            btn.Text = txt .. ": " .. (val and "ON" or "OFF")
            btn.BackgroundColor3 = val and (customColor or Color3.fromRGB(50, 200, 50)) or Color3.fromRGB(40, 40, 40)
        end
    end)

    btn.MouseButton1Click:Connect(function()
        if isGlobal then
            _G[varName] = not _G[varName]
        else
            if not getgenv()[varName] then -- Mau nyalain
                task.wait(2)
                if #getInventoryData() <= 1 then warn("Safety: Only 1 left!") return end
            end
            getgenv()[varName] = not getgenv()[varName]
        end
    end)
end

createBtn("SEND (R)", "AutoTradeGalactio", false, Color3.fromRGB(138, 43, 226))
createBtn("AUTO ACCEPT (Q)", "AutoTradeEnabled", true, Color3.fromRGB(0, 150, 255))

local userBox = Instance.new("TextBox", mainFrame)
userBox.Size = UDim2.new(0.9, 0, 0, 35)
userBox.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
userBox.TextColor3 = Color3.new(1, 1, 1)
userBox.Text = getgenv().nickname
userBox.PlaceholderText = "Target Nickname..."
Instance.new("UICorner", userBox)
userBox.FocusLost:Connect(function() getgenv().nickname = userBox.Text end)

local footer = Instance.new("TextLabel", mainFrame)
footer.Size = UDim2.new(1, 0, 0, 70)
footer.Text = "R: Send (Safety 2s) | Q: Accept\nJ: Hide UI\nStatus: Always leaves 1 item\nTarget: AkbarSiRaja_283"
footer.TextColor3 = Color3.fromRGB(150, 150, 150)
footer.BackgroundTransparency = 1
footer.TextSize = 8

-- --- KEYBIND HANDLER ---
UIS.InputBegan:Connect(function(input, processed)
    if processed then return end 
    
    if input.KeyCode == Enum.KeyCode.R then
        if not getgenv().AutoTradeGalactio then
            task.wait(2) -- Delay pengecekan sesuai request
            if #getInventoryData() <= 1 then return end
        end
        getgenv().AutoTradeGalactio = not getgenv().AutoTradeGalactio
        
    elseif input.KeyCode == Enum.KeyCode.Q then
        _G.AutoTradeEnabled = not _G.AutoTradeEnabled
        
    elseif input.KeyCode == Enum.KeyCode.J then
        mainFrame.Visible = not mainFrame.Visible
    end
end)
